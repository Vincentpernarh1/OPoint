<!DOCTYPE html>
<html>
<head>
  <title>Test Push Notifications</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px 0;
      font-size: 16px;
      cursor: pointer;
    }
    .success { color: green; }
    .error { color: red; }
    pre {
      background: #f4f4f4;
      padding: 10px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Push Notification Test</h1>
  
  <div id="status"></div>
  
  <button onclick="testPermission()">1. Check Permission</button><br>
  <button onclick="testServiceWorker()">2. Check Service Worker</button><br>
  <button onclick="testLocalNotification()">3. Test Local Notification</button><br>
  <button onclick="showSubscription()">4. Show Subscription</button><br>
  
  <pre id="log"></pre>

  <script>
    function log(message, isError = false) {
      const logEl = document.getElementById('log');
      const statusEl = document.getElementById('status');
      const msg = `[${new Date().toLocaleTimeString()}] ${message}\n`;
      logEl.textContent += msg;
      statusEl.innerHTML = `<p class="${isError ? 'error' : 'success'}">${message}</p>`;
      console.log(message);
    }

    async function testPermission() {
      try {
        const permission = Notification.permission;
        log(`Notification permission: ${permission}`);
        
        if (permission === 'default') {
          const result = await Notification.requestPermission();
          log(`Permission result: ${result}`, result !== 'granted');
        }
      } catch (error) {
        log(`Error: ${error.message}`, true);
      }
    }

    async function testServiceWorker() {
      try {
        if (!('serviceWorker' in navigator)) {
          log('Service Workers not supported!', true);
          return;
        }

        const registration = await navigator.serviceWorker.getRegistration();
        if (registration) {
          log(`Service Worker registered! Scope: ${registration.scope}`);
          log(`Active: ${!!registration.active}`);
        } else {
          log('No Service Worker registration found', true);
          
          // Try to register
          log('Attempting to register service worker...');
          const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
          log(`Service Worker registered successfully! Scope: ${reg.scope}`);
        }
      } catch (error) {
        log(`Error: ${error.message}`, true);
      }
    }

    async function testLocalNotification() {
      try {
        if (Notification.permission !== 'granted') {
          log('Please grant notification permission first!', true);
          return;
        }

        const registration = await navigator.serviceWorker.ready;
        
        await registration.showNotification('Test Notification', {
          body: 'This is a test notification from OPoint',
          icon: '/favicon.svg',
          badge: '/favicon.svg',
          vibrate: [200, 100, 200],
          tag: 'test',
          requireInteraction: false
        });
        
        log('✅ Local notification sent!');
      } catch (error) {
        log(`Error: ${error.message}`, true);
      }
    }

    async function showSubscription() {
      try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          log('✅ Push subscription exists:');
          log(JSON.stringify(subscription.toJSON(), null, 2));
        } else {
          log('❌ No push subscription found', true);
        }
      } catch (error) {
        log(`Error: ${error.message}`, true);
      }
    }

    // Auto-run tests
    window.addEventListener('load', () => {
      log('Page loaded. Click buttons to test...');
    });
  </script>
</body>
</html>
